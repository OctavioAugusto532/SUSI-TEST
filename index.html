<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SUSI — Triagem (web)</title>
  <style>
    /* Reset curto */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:#F2F3F5; color:#0f172a; }

    /* Container principal */
    .app {
      width: 100%;
      max-width: 920px;
      height: 92vh;
      margin: 24px auto;
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 6px 30px rgba(15,23,42,0.06);
      display: grid;
      grid-template-rows: 86px 1fr 84px;
      overflow: hidden;
    }

    /* Header */
    .header {
      display:flex;
      align-items:center;
      gap:14px;
      padding: 18px;
      background: linear-gradient(0deg, rgba(242,243,245,0.6), rgba(242,243,245,0.6));
    }
    .avatar {
      width:56px; height:56px; border-radius:50%; background:#3b82f6; display:flex; align-items:center; justify-content:center; color:white;
      font-weight:700;
    }
    .title { line-height:1; }
    .title h1 { font-size:18px; margin-bottom:4px; }
    .title p { font-size:12px; color:#475569; }

    /* Messages area */
    .messages {
      padding: 18px;
      overflow-y: auto;
      background: linear-gradient(180deg, #F2F3F5 0%, #F8FAFC 100%);
    }
    .messages-inner { max-width:760px; margin: 0 auto; display:flex; flex-direction:column; gap:10px; }

    /* Bubble common */
    .bubble-row { display:flex; gap:8px; align-items:flex-end; }
    .bubble { max-width: 72%; padding:10px 14px; border-radius:14px; line-height:1.35; font-size:14px; word-wrap:break-word; }
    .bubble.bot { background:#E9EAEB; color:#111827; border-bottom-left-radius:6px; }
    .bubble.user { background:#0084FF; color:#fff; margin-left:auto; border-bottom-right-radius:6px; text-align:right; }
    .meta { font-size:11px; color:#94a3b8; margin-top:6px; }

    /* Typing indicator */
    .typing { display:inline-block; padding:8px 12px; background:#E9EAEB; border-radius:12px; }
    .dots span { display:inline-block; width:6px; height:6px; margin: 0 2px; background:#64748B; border-radius:50%; animation: blink 1s infinite; opacity:0.9; }
    .dots span:nth-child(2){ animation-delay: .12s }
    .dots span:nth-child(3){ animation-delay: .24s }
    @keyframes blink { 0% { opacity:0.2; transform: translateY(0);} 50% { opacity:1; transform: translateY(-3px);} 100% { opacity:0.2; transform: translateY(0);} }

    /* Input area */
    .composer {
      padding: 12px 16px;
      display:flex;
      gap:10px;
      align-items:center;
      border-top: 1px solid rgba(15,23,42,0.04);
      background:#fff;
    }
    .input {
      flex:1;
      display:flex;
      gap:8px;
      align-items:center;
      background:#F8FAFC;
      padding:8px;
      border-radius:10px;
    }
    .input input {
      flex:1;
      border:0;
      outline:none;
      background:transparent;
      padding:10px;
      font-size:15px;
    }
    button.btn {
      border:0;
      padding:10px 14px;
      border-radius:8px;
      cursor:pointer;
      font-weight:600;
    }
    button.send { background:#0084FF; color:white; }
    button.clear { background:#F3F4F6; color:#0f172a; }

    /* Small screens */
    @media (max-width:640px) {
      .app { margin: 10px; height: 94vh; }
      .messages-inner { max-width:100%; }
      .bubble { font-size:15px; }
    }
  </style>
</head>
<body>
  <div class="app" role="main" aria-label="SUSI Triagem">
    <header class="header">
      <div class="avatar" aria-hidden="true">DA</div>
      <div class="title">
        <h1>SUSI</h1>
        <p>Triagem de Saúde • Atendimento automatizado</p>
      </div>
    </header>

    <section class="messages" id="messages" aria-live="polite">
      <div class="messages-inner" id="messagesInner">
        <!-- mensagens serão inseridas aqui -->
      </div>
    </section>

    <footer class="composer" role="region" aria-label="Área de composição">
      <div class="input">
        <input id="inputMsg" type="text" placeholder="Descreva seus sintomas ou dúvidas..." aria-label="Mensagem"/>
      </div>
      <button class="btn clear" id="btnClear" title="Limpar">Limpar</button>
      <button class="btn send" id="btnSend" title="Enviar">Enviar</button>
    </footer>
  </div>

  <script>
    /* Configurações: ajusta os endpoints conforme seu backend */
    const CHAT_ENDPOINT = "/api/chat"; // endpoint do backend (POST) que retorna JSON { reply: "texto..." }
    const REQUEST_TIMEOUT = 30000; // ms

    const messagesInner = document.getElementById("messagesInner");
    const messagesBox = document.getElementById("messages");
    const input = document.getElementById("inputMsg");
    const btnSend = document.getElementById("btnSend");
    const btnClear = document.getElementById("btnClear");

    function addBotBubble(text, opts = {}) {
      const row = document.createElement("div");
      row.className = "bubble-row";
      const avatar = document.createElement("div");
      avatar.style.width = "36px";
      avatar.style.height = "36px";
      avatar.style.borderRadius = "50%";
      avatar.style.display = "flex";
      avatar.style.alignItems = "center";
      avatar.style.justifyContent = "center";
      avatar.style.background = "#64748B";
      avatar.style.color = "white";
      avatar.style.fontSize = "12px";
      avatar.style.fontWeight = "600";
      avatar.textContent = "DA";

      const bubble = document.createElement("div");
      bubble.className = "bubble bot";
      bubble.innerHTML = sanitize(text);

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

      const left = document.createElement("div");
      left.style.display = "flex";
      left.style.flexDirection = "column";
      left.appendChild(avatar);
      left.appendChild(document.createElement("div")); // spacer

      const col = document.createElement("div");
      col.style.display = "flex";
      col.style.flexDirection = "column";
      col.appendChild(bubble);
      col.appendChild(meta);

      row.appendChild(col);
      messagesInner.appendChild(row);
      scrollToBottom();
    }

    function addUserBubble(text) {
      const row = document.createElement("div");
      row.className = "bubble-row";
      const bubble = document.createElement("div");
      bubble.className = "bubble user";
      bubble.textContent = text;

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

      const col = document.createElement("div");
      col.style.display = "flex";
      col.style.flexDirection = "column";
      col.style.alignItems = "flex-end";
      col.appendChild(bubble);
      col.appendChild(meta);

      row.appendChild(col);
      messagesInner.appendChild(row);
      scrollToBottom();
    }

    function sanitize(str){
      // conteúdo simples: escape de < e >
      return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g, "<br/>");
    }

    function scrollToBottom(){
      requestAnimationFrame(() => {
        messagesBox.scrollTop = messagesBox.scrollHeight;
      });
    }

    function showTyping(){
      const row = document.createElement("div");
      row.id = "typingRow";
      row.className = "bubble-row";
      const avatar = document.createElement("div");
      avatar.style.width = "36px";
      avatar.style.height = "36px";
      avatar.style.borderRadius = "50%";
      avatar.style.display = "flex";
      avatar.style.alignItems = "center";
      avatar.style.justifyContent = "center";
      avatar.style.background = "#64748B";
      avatar.style.color = "white";
      avatar.style.fontSize = "12px";
      avatar.style.fontWeight = "600";
      avatar.textContent = "DA";

      const wrapper = document.createElement("div");
      const typing = document.createElement("div");
      typing.className = "typing";
      const dots = document.createElement("div");
      dots.className = "dots";
      dots.innerHTML = '<span></span><span></span><span></span>';
      typing.appendChild(dots);
      wrapper.appendChild(typing);

      row.appendChild(wrapper);
      messagesInner.appendChild(row);
      scrollToBottom();
    }

    function hideTyping(){
      const r = document.getElementById("typingRow");
      if (r) r.remove();
    }

    async function sendMessageToBackend(messageText) {
      // Faz um POST ao backend; espera JSON { reply: "texto..." }
      const controller = new AbortController();
      const timer = setTimeout(() => controller.abort(), REQUEST_TIMEOUT);

      try {
        const res = await fetch(CHAT_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: messageText }),
          signal: controller.signal
        });
        clearTimeout(timer);
        if (!res.ok) {
          const text = await res.text();
          throw new Error(`Servidor retornou ${res.status}: ${text}`);
        }
        const data = await res.json();
        // Aceita duas formas: { reply: "..." } ou { message: "..." }
        return data.reply ?? data.message ?? (data.result ?? JSON.stringify(data));
      } catch (err) {
        if (err.name === 'AbortError') throw new Error("Tempo de requisição esgotado.");
        throw err;
      }
    }

    async function handleSend() {
      const text = input.value.trim();
      if (!text) return;
      input.value = "";
      addUserBubble(text);
      showTyping();
      try {
        const reply = await sendMessageToBackend(text);
        hideTyping();
        addBotBubble(reply);
      } catch (err) {
        hideTyping();
        addBotBubble("❌ Erro ao conectar com o servidor: " + err.message);
      }
    }

    // atalhos UI
    btnSend.addEventListener("click", handleSend);
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        handleSend();
      }
    });
    btnClear.addEventListener("click", () => {
      messagesInner.innerHTML = "";
      addBotBubble("Olá! Sou o SUSI. Descreva seus sintomas ou dúvidas sobre saúde. Posso sugerir especialistas e hospitais locais.");
    });

    // Mensagem inicial
    addBotBubble("Olá! Sou o SUSI. Descreva seus sintomas ou dúvidas sobre saúde. Posso sugerir especialistas e hospitais locais.");
  </script>
</body>
</html>
